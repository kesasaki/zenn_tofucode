---
title: "[APIæ§‹ç¯‰10] line-bot-sdk-goã¨ngrokã§chatbotã‚’ä½œã‚‹"
emoji: "ğŸ•"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: 
 - "gin"
 - "linemessagingapi"
 - "line-bot-sdk-go"
 - "ngrok"
 - "linedevelopers"
published: true
---

# æ¦‚è¦
lineã‚¢ãƒ—ãƒªã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã¨ã‚ªã‚¦ãƒ è¿”ã—ã§è¿”ç­”ã‚’è¡Œã†botã‚µãƒ¼ãƒã‚’ä½œæˆã™ã‚‹ã€‚
ãƒ­ãƒ¼ã‚«ãƒ«ã«botã‚µãƒ¼ãƒã‚’ä½œã‚Šã€lineã®è¨­å®šã‚’è¡Œã£ã¦lineã‚¢ãƒ—ãƒªã¸ã®è¿”ç­”ã‚’botã‚µãƒ¼ãƒãŒè¡Œã†ã‚ˆã†ã«ã™ã‚‹ã€‚

# botã‚µãƒ¼ãƒã®ä½œæˆ
ãƒ­ãƒ¼ã‚«ãƒ«ã«lineã‹ã‚‰ã®webhookã‚’å—ã‘ã¦ãƒªãƒ—ãƒ©ã‚¤ã‚’è¿”ã™botã‚µãƒ¼ãƒã‚’ä½œæˆã™ã‚‹ã€‚

## line-bot-sdk-go
line-bot-sdk-goã¯goã§linebotã‚’ä½œæˆã—ã‚„ã™ãã™ã‚‹ãŸã‚ã®ã‚‚ã®ã€‚
> LINE Messaging API SDK for Go ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€LINE Messaging API ã‚’ä½¿ç”¨ã—ãŸãƒœãƒƒãƒˆã®é–‹ç™ºãŒç°¡å˜ã«ãªã‚Šã€æ•°åˆ†ã§ã‚µãƒ³ãƒ—ãƒ«ãƒœãƒƒãƒˆã‚’ä½œæˆã§ãã¾ã™ã€‚

æœ¬æ¥lineã®botä½œæˆã¯messaging APIã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚APIã‚’ä½œæˆã—webhookã‚’è¨­å®šã™ã‚‹ã¨ã„ã†æ‰‹é †ã‚’è¸ã‚€ãŒã€LINEã¯ã“ã‚Œã‚’å„è¨€èªã§ç°¡å˜ã«å®Ÿè£…ã™ã‚‹SDKã‚’ä½œæˆã™ã‚‹ã€‚line-bot-sdk-goã¯ãã‚Œã®goç‰ˆã€‚
ä»Šå›ã¯ã“ã‚Œã‚’åˆ©ç”¨ã—ã¦ã‚ªã‚¦ãƒ è¿”ã—ã‚’ã™ã‚‹linebotã‚’ä½œæˆã™ã‚‹ã€‚

https://github.com/line/line-bot-sdk-go

https://developers.line.biz/ja/docs/messaging-api/overview/

https://developers.line.biz/ja/reference/messaging-api/

## line-bot-sdk-goã®å°å…¥
line-bot-sdk-goã®githubã®READMEã‚’å‚è€ƒã«å°å…¥ã™ã‚‹ã€‚
```
go get -u github.com/line/line-bot-sdk-go/v7/linebot
```

## ã‚µãƒ¼ãƒãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’æ›¸ã
ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’æŒã¤ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’æ›¸ãã¾ã™ã€‚
| APIå | ãƒ‘ã‚¹ | HTTPãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜ |
| - | - | - | - |
| å‹•ä½œç¢ºèªAPI | / | GET | å‹•ä½œç¢ºèªç”¨ã«ãƒ–ãƒ©ã‚¦ã‚¶ã§GETã§å›ºå®šå€¤ã€Œhello workdã€ã‚’è¿”ã™API |
| LINEãƒãƒ£ãƒƒãƒˆbotãƒªãƒ—ãƒ©ã‚¤API | /callback | POST | LINEã‚¢ãƒ—ãƒªã‹ã‚‰ã®è¿”ç­”ã«å¯¾ã™ã‚‹ãƒªãƒ—ãƒ©ã‚¤ã‚’è¡Œã†API |

ã‚³ãƒ¼ãƒ‰
```golang
package main

import (
	"fmt"
	"net/http"
	"os"

	"github.com/gin-gonic/gin"
	"github.com/line/line-bot-sdk-go/v7/linebot"
)

func main() {
	engine := gin.Default()
	engine.GET("/", getTop)
	engine.POST("/callback", postCallback)
	engine.Run(":" + os.Getenv("PORT"))
}

func getTop(c *gin.Context) {
	c.JSON(http.StatusOK, gin.H{
		"message": "hello world",
	})
}

func postCallback(c *gin.Context) {
	// botä½œæˆ
	bot, err := linebot.New(
		os.Getenv("CHANNEL_SECRET"),
		os.Getenv("CHANNEL_TOKEN"),
	)
	if err != nil {
		fmt.Println(err.Error())
		return
	}

	// ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†
	events, berr := bot.ParseRequest(c.Request)
	if berr != nil {
		fmt.Println(berr.Error())
		return
	}
	for _, event := range events {
		if event.Type == linebot.EventTypeMessage {
			switch message := event.Message.(type) {
			case *linebot.TextMessage:
				_, rerr := bot.ReplyMessage(
					event.ReplyToken,
					linebot.NewTextMessage(getResMessage(message.Text)),
				).Do()
				if rerr != nil {
					fmt.Println(rerr.Error())
				}
			}
		}
	}
}

func getResMessage(message string) string {
	return "ã‚ãªãŸã¯" + message + "ã¨è¨€ã„ã¾ã—ãŸã€‚"
}
```

å‚è€ƒã«ã—ãŸline-bot-sdk-goã®ã‚µãƒ³ãƒ—ãƒ«
https://github.com/line/line-bot-sdk-go/blob/master/examples/echo_bot/server.go

(ginã®æ›¸ãæ–¹ã«ã¤ã„ã¦ã¯ã‚‚ã†å°‘ã—é€²ã‚ã¦ã‹ã‚‰æ”¹ã‚ã¦å‹‰å¼·ã—ãªãŠã™)

## å®Ÿè¡Œ

```
export PORT=8080
export CHANNEL_TOKEN=<ãƒˆãƒ¼ã‚¯ãƒ³>
export CHANNEL_SECRET=<ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ>
go run api/main.go
```

## å‹•ä½œç¢ºèª
ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ç¢ºèªAPIã¸ã‚¢ã‚¯ã‚»ã‚¹ã—è¿”ç­”ãŒãã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸã€‚
![](/images/504bfdd232a0d2/ss51.jpg =300x)

# botã‚µãƒ¼ãƒã‚’å¤–éƒ¨å…¬é–‹ã™ã‚‹ï¼ˆhttpsã¨ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ç”¨æ„ã™ã‚‹)
LINEã‚¢ãƒ—ãƒªã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã‚‹ã«ã¯LINEãŒbotã‚µãƒ¼ãƒã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã€botã‚µãƒ¼ãƒã®htpsã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’LINE Developersã«ç™»éŒ²ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
ã—ã‹ã—é–‹ç™ºç’°å¢ƒã‚’æ•´ãˆã‚‹ãŸã‚ã ã‘ã«æœ¬ç•ªç’°å¢ƒæ§‹ç¯‰ã§ã‚ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ç™ºè¡Œã¨httpsã®è¨­å®šã‚’ã™ã‚‹ã®ã¯ã‚¹ãƒãƒ¼ãƒˆã§ã¯ãªã„ã€‚
ãªã®ã§ã“ã“ã§ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚µãƒ¼ãƒã‚’ãŠæ‰‹è»½ã«å¤–éƒ¨å…¬é–‹ï¼ˆhttpsã¨ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ä»˜ä¸ï¼‰ãŒã§ãã‚‹ngrokã‚’åˆ©ç”¨ã™ã‚‹ã€‚

https://qiita.com/mininobu/items/b45dbc70faedf30f484e

## ngrokã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```
brew install ngrok
```

## ngrokã®å®Ÿè¡Œ

```
ngrok http 8080

ngrok                                                                                                                                                                                                                                                                                                                                                     (Ctrl+C to quit)

ğŸ¤¯ Try the ngrok Kubernetes Ingress Controller: https://ngrok.com/s/k8s-ingress

Session Status                online
Session Expires               1 hour, 59 minutes
Terms of Service              https://ngrok.com/tos
Version                       3.3.1
Region                        Japan (jp)
Latency                       24ms
Web Interface                 http://127.0.0.1:4040
Forwarding                    https://88f6-2407-c800-1f11-777-adb4-51c1-c926-e461.ngrok.io -> http://localhost:8080

Connections                   ttl     opn     rt1     rt5     p50     p90
                              0       0       0.00    0.00    0.00    0.00
```

å®Ÿè¡Œã®ãŸã³ã«localhost:8080ã«æ¥ç¶šã™ã‚‹URLã‚’æ‰•ã„å‡ºã—ã¦ãã‚Œã‚‹ã€‚

## å‹•ä½œç¢ºèª
ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ngrokçµŒç”±ã§ç¢ºèªAPIã¸ã‚¢ã‚¯ã‚»ã‚¹ã—è¿”ç­”ã‚’ç¢ºèªã—ãŸã€‚
![](/images/504bfdd232a0d2/ss52.jpg =500x)

# LINE Developersã®WebhookURLã®è¨­å®š
ä½œæˆã—ãŸ`https://88f6-2407-c800-1f11-777-adb4-51c1-c926-e461.ngrok.io/callback`ã‚’[LINE Developersã‚³ãƒ³ã‚½ãƒ¼ãƒ«](https://developers.line.biz/console/)ã®WebhookURLã«è¨­å®šã™ã‚‹ã€‚ï¼ˆç”»åƒã ã¨4f65ã‹ã‚‰å§‹ã¾ã‚‹URLã«ãªã£ã¦ã„ã‚‹ãŒã€ã“ã®ã‚ã¨88f6ã®ã‚‚ã®ã‚’è¨­å®šã—ã¦ã„ã‚‹ã€‚ï¼‰

![](/images/504bfdd232a0d2/ss53.jpg =600x)

Webhookã®åˆ©ç”¨ã‚’ONã«ã™ã‚‹ã€‚

![](/images/504bfdd232a0d2/ss54.jpg =600x)

ã€Œæ¤œè¨¼ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã€æˆåŠŸã¨å‡ºã‚Œã°OKã€‚

![](/images/504bfdd232a0d2/ss55.jpg =600x)

# LINEã‚¢ãƒ—ãƒªã‹ã‚‰å‹•ä½œç¢ºèªã™ã‚‹
LINE ã‚¢ãƒ—ãƒªã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚Šã€è¿”ç­”ã•ã‚Œã‚‹ã‹ç¢ºèªã™ã‚‹ã€‚
[LINE Developersã‚³ãƒ³ã‚½ãƒ¼ãƒ«](https://developers.line.biz/console/)ã®MessageAPIè¨­å®šã®QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ãƒãƒ›ã§èª­ã¿è¾¼ã¿ã€LINEã‚¢ãƒ—ãƒªã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã€‚è¿”ç­”ãŒæ¥ãŸã€‚æˆåŠŸã€‚

![](/images/504bfdd232a0d2/ss56.jpg =300x)

# æ‰€æ„Ÿ
ngrokãŒã‚ã¡ã‚ƒãã¡ã‚ƒä¾¿åˆ©ã€‚è¤‡é›‘ãªè¨­å®šãªã—ã®1ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œã§ãã‚‹ã®ãŒå¤§å¤‰ã‚ã‚ŠãŒãŸã„ã€‚
line-bot-sdk-goãŒã¨ã¦ã‚‚ä¾¿åˆ©ã€‚APIã ã‘ã§ã‚„ã‚ã†ã¨ã™ã‚‹ã¨ã€post APIã¸ã®è¿”ç­”ã¯200ã®ã¿ã§ã€ãƒªãƒ—ãƒ©ã‚¤ã¯åˆ¥APIã§ã“ã¡ã‚‰ã‹ã‚‰ã‚³ãƒ¼ãƒ«ã™ã‚‹ä»•çµ„ã¿ã®ãŸã‚å°‘ã€…é¢å€’ã ãŒã€ã“ã‚Œã‚’ç›´æ„Ÿçš„ã«ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§ãã‚‹ã®ã¯ã¨ã¦ã‚‚è‰¯ã„ã€‚
æ³¨æ„ç‚¹ã¨ã—ã¦ã€SDKã®READMEã«ã‚ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒªãƒ³ã‚¯ãŒ[messaging API](https://developers.line.biz/ja/reference/messaging-api/)ã¸ã®ãƒªãƒ³ã‚¯ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€SDKè‡ªä½“ã®è©³ç´°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯å­˜åœ¨ã›ãšã€è©³ç´°ä»•æ§˜ãŒçŸ¥ã‚ŠãŸã‘ã‚Œã°[message APIã®ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](https://developers.line.biz/ja/reference/messaging-api/)ã‹ã‚‰æ¨æ¸¬ã™ã‚‹ã—ã‹ãªã•ãã†ã€‚ãã‚Œã§ååˆ†ã ã¨è‰¯ã„ãŒã€‚ã‚³ãƒ¼ãƒ‰èª­ã‚ã£ã¦ã“ã¨ã‹ã€‚ã€‚ã€‚
ã¾ãŸã€SDKã‚µãƒ³ãƒ—ãƒ«ã§ã¯å—ã‘å–ã£ãŸPOST APIã‚¢ã‚¯ã‚»ã‚¹ã«å¯¾ã—ã¦ã™ãã«`bot.ReplyMessage.Do()` ã‚’è¡Œã£ã¦ã„ã‚‹ãŒã€[messaging-apiã®ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã§HTTP POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ã‚’éåŒæœŸåŒ–ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¦ã„ã‚‹](https://developers.line.biz/ja/reference/messaging-api/#webhooks)ï¼ˆâ€»å‚è€ƒç”»åƒï¼‰ã“ã¨ã‹ã‚‰ã€LINEã¨ã—ã¦ã¯POST APIã‚¢ã‚¯ã‚»ã‚¹ã¨ãƒªãƒ—ãƒ©ã‚¤ã‚’éåŒæœŸå‡¦ç†ã«ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¦ã„ã‚‹æ°—ãŒã™ã‚‹ã€‚ãƒœãƒƒãƒˆã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã‚„å‡¦ç†ãŒå¢—ãˆãŸã‚‰éåŒæœŸåŒ–ã‚’æ¤œè¨ã™ã‚‹ã€‚goroutineã§ã®ä¸¦è¡Œå‡¦ç†ã¯å¥½ããªã®ã§æ¥½ã—ã¿ã€‚

â€»å‚è€ƒç”»åƒ
![](/images/504bfdd232a0d2/ss57.jpg =600x)

https://developers.line.biz/ja/reference/messaging-api/

# å‚è€ƒ
https://qiita.com/Aki_Mineo/items/941dbd722e9d1754308d
