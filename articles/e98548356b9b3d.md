---
title: "[APIæ§‹ç¯‰10] terraformã§ECSã®æ§‹æˆç®¡ç†"
emoji: "ğŸ”–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: 
  - "terraform"
  - "ECS"
  - "AWS"
published: true
---

# æ¦‚è¦
å‰å›ã¾ã§ã®è¨˜äº‹ã§ECSã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã—HTTPSã§å…¬é–‹ã™ã‚‹ã“ã¨ã‚‚ã§ããŸã€‚
ã ãŒã€å…¨éƒ¨ä½œã£ã¦ã‚ã‚‹ãŸã‚ã‚³ãƒ¼ãƒ‰ã®æ›´æ–°ã‚’åæ˜ ã™ã‚‹ã®ãŒæ¯å›ä½œã‚Šç›´ã—ã¨ãªã‚Šè¶…ã ã‚‹ã„ã€‚
CDã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
ãã®å‰æ®µéšã¨ã—ã¦terraformã§æ§‹æˆã‚’ç®¡ç†ã™ã‚‹ã€‚

å‰å›ã®è¨˜äº‹
https://zenn.dev/tofucode/articles/c07cea0be768b3

# å°å…¥
https://www.terraform.io/

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```sh
brew tap hashicorp/tap
brew install hachâ€‹â€‹icorp/tap/terraform
terraform -install-autocomplete
```

# ã‚³ãƒãƒ³ãƒ‰
åˆæœŸåŒ–
```sh
terraform init
```

å¤‰æ›´ã®åæ˜ 
```sh
terraform apply
```

ä½œæˆã—ãŸãƒªã‚½ãƒ¼ã‚¹ã®ç ´æ£„
```sh
terraform destroy
```

æ§‹æˆã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
```sh
terraform fmt
```

æ§‹æˆã®æ¤œè¨¼
```sh
terraform validate
```

import è¨­å®šæ¸ˆã¿ã®ã‚ã‚Œã“ã‚Œã‚’.tfãƒ•ã‚¡ã‚¤ãƒ«ã«ã™ã‚‹!!!
```sh
terraform import
```

plan å¤‰æ›´å·®åˆ†ã®ç¢ºèª
```
terraform plan
```

# .tfãƒ•ã‚¡ã‚¤ãƒ«
.tfãƒ•ã‚¡ã‚¤ãƒ«ã¯æ§‹æˆã‚’è¨˜è¿°ã™ã‚‹terraformã®æ ¸ã¨ãªã‚‹ãƒ•ã‚¡ã‚¤ãƒ«

.tfä¾‹
```tf
terraform {}

provider "aws" {
  region = "ap-northeast-1"
}

resource "aws_ecs_cluster" "test" {}

resource "aws_ecs_task_definition" "test" {}

resource "aws_ecs_service" "test" {}
```

.tfãƒ•ã‚¡ã‚¤ãƒ«ã®é‡è¦ãƒ–ãƒ­ãƒƒã‚¯
| ãƒ–ãƒ­ãƒƒã‚¯å | å’Œå | èª¬æ˜ |
| - | - | - |
| terraform | ãƒ†ãƒ©ãƒ•ã‚©ãƒ¼ãƒ ãƒ–ãƒ­ãƒƒã‚¯ | ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®å®šç¾©ï¼ˆã‚½ãƒ¼ã‚¹ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰ã‚’æ›¸ã |
| provider | ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ | ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®æ§‹æˆï¼ˆç™»éŒ²ã™ã‚‹æƒ…å ±ç¾¤ï¼‰ã‚’æ›¸ãã€‚<br>Terraformã«å¯¾ã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ |
| resource | ãƒªã‚½ãƒ¼ã‚¹ | ãƒªã‚½ãƒ¼ã‚¹ã«ç™»éŒ²ã™ã‚‹æƒ…å ±ã‚’æ›¸ã |

## ãƒªã‚½ãƒ¼ã‚¹
ãƒªã‚½ãƒ¼ã‚¹ãƒ–ãƒ­ãƒƒã‚¯ã®ä¾‹
```tf
resource "aws_instance" "web" {
  ami           = "ami-a1b2c3d4"
  instance_type = "t2.micro"
}
```

æ§‹æ–‡
| ä¾‹å†…ã®å˜èª | ç”¨èª | å½¹å‰² |
| - | - | - |
| resource | ãƒ–ãƒ­ãƒƒã‚¯ã‚¿ã‚¤ãƒ— | ãƒªã‚½ãƒ¼ã‚¹ã§ã‚ã‚‹ã“ã¨ã®è­˜åˆ¥å­ |
| aws_instance | ãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ— | ãƒªã‚½ãƒ¼ã‚¹ã®ç¨®é¡ |
| web | ãƒ­ãƒ¼ã‚«ãƒ«å | å‘¼ã³å |
| ami, instance_type | å¼•æ•° | ãƒªã‚½ãƒ¼ã‚¹ã«å…¥ã‚Œã‚‹å¼•æ•° |

## ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼
ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒ–ãƒ­ãƒƒã‚¯ã®ä¾‹
```tf
provider "google" {
  project = "acme-app"
  region  = "us-central1"
}
```

æ§‹æ–‡
| ä¾‹å†…ã®å˜èª | ç”¨èª | å½¹å‰² |
| - | - | - |
| provider | ãƒ–ãƒ­ãƒƒã‚¯ã‚¿ã‚¤ãƒ— | providerã§ã‚ã‚‹ã“ã¨ã®è­˜åˆ¥å­ |
| google | ãƒ­ãƒ¼ã‚«ãƒ«å | å‘¼ã³å |
| project, region | å¼•æ•° | providerã«å…¥ã‚Œã‚‹å¼•æ•°ã€‚providerå´ã§æŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã€‚ |


## terraformã§ã®AWS ECSæ§‹æˆç®¡ç†
ä»¥ä¸‹ã®è¨˜äº‹ã«æ²¿ã£ã¦terraformã®è¨­å®šã‚’è¡Œã†ã€‚
https://zenn.dev/streamwest1629/articles/terraform_import-for_beginner

ã¾ãšmain.tfã‚’æ›¸ã

main.tf
```tf
terraform {}

provider "aws" {
  region = "ap-northeast-1"
}

resource "aws_ecs_cluster" "test" {}

resource "aws_ecs_task_definition" "test" {}

resource "aws_ecs_service" "test" {}
```

AWS CLIã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹
```
aws configure sso
```
https://zenn.dev/tofucode/articles/c30bf6fbfcfe8a

ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—è¨­å®šæ¸ˆã¿ã®ECSã®è¨­å®šã‚’å–ã‚Šè¾¼ã‚€(terraform import)
```sh
AWS_PROFILE=AdministratorAccess-588666138300 terraform import aws_ecs_task_definition.test arn:aws:ecs:ap-northeast-1:588666138300:task-definition/aichatbot-dockerhub-task-familly:1

AWS_PROFILE=AdministratorAccess-588666138300 terraform import aws_ecs_cluster.test aichatbot-cluster

AWS_PROFILE=AdministratorAccess-588666138300 terraform import aws_ecs_service.test aichatbot-cluster/aichatbot-service-https
```

main.tfã‚’ä¿®æ­£ã™ã‚‹ã€‚

:::details main.tf(ä¿®æ­£å¾Œ)
```tf
terraform {}

provider "aws" {
  region = "ap-northeast-1"
}

resource "aws_ecs_cluster" "test" {
  name = "aichatbot-cluster"
}

resource "aws_ecs_service" "test" {
  name = "aichatbot-service-https"
}

resource "aws_ecs_task_definition" "test" {
  family                = "aichatbot-dockerhub-task-familly"
  container_definitions = jsonencode([
        {
            "name": "aichatbot-dockerhub-container",
            "image": "kesasasaki/aichatbotrepository:latest",
            "cpu": 0,
            "portMappings": [
                {
                    "name": "aichatbot-dockerhub-container-80-tcp",
                    "containerPort": 80,
                    "hostPort": 80,
                    "protocol": "tcp",
                    "appProtocol": "http"
                }
            ],
            "essential": true,
            "environment": [
                {
                    "name": "LINE_CHANNEL_TOKEN",
                    "value": "xxxx"
                },
                {
                    "name": "LINE_CHANNEL_SECRET",
                    "value": "xxxx"
                },
                {
                    "name": "OPENAI_API_KEY",
                    "value": "xxxx"
                },
                {
                    "name": "PORT",
                    "value": "80"
                },
                {
                    "name": "DEBUG",
                    "value": "true"
                }
            ],
            "environmentFiles": [],
            "mountPoints": [],
            "volumesFrom": [],
            "ulimits": [],
            "logConfiguration": {
                "logDriver": "awslogs",
                "options": {
                    "awslogs-create-group": "true",
                    "awslogs-group": "/ecs/aichatbot-dockerhub-task-familly",
                    "awslogs-region": "ap-northeast-1",
                    "awslogs-stream-prefix": "ecs"
                },
                "secretOptions": []
            }
        }
    ])
}
```

:::message
æ³¨æ„
ecs teskå®šç¾©ã®container_definitionsã¯ECSã‹ã‚‰ã‚³ãƒ”ã£ãŸã®ã‚’ãã®ã¾ã¾ã§ã¯ãªãã€ã‚³ãƒ”ã£ãŸã‚‚ã®ã®ä¸€éƒ¨ã‚’è²¼ã‚‹æ„Ÿã˜ã§ã™ã€‚
ä»¥ä¸‹ã‚’è¦‹ã¦ãã ã•ã„ã€‚
https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/ecs_task_definition

ECSã‹ã‚‰ã‚³ãƒ”ã£ãŸã®
```json
{
    "taskDefinitionArn": "arn:aws:ecs:ap-northeast-1:588666138300:task-definition/aichatbot-dockerhub-task-familly:1",
    "containerDefinitions": [
        {
            "name": "aichatbot-dockerhub-container",
            "image": "kesasasaki/aichatbotrepository:latest"
        }
    ]
}
```

container_definitionsã«å…¥ã‚Œã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
```json
[
    {
      name      = "first"
      image     = "service-first"
    }
]
```
:::

ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—å¤‰æ›´å·®åˆ†ã®ç¢ºèª(terraform plan)
```sh
AWS_PROFILE=AdministratorAccess-588666138300 terraform plan
```

ã§ããŸã€‚æ¬¡ã¯vpc, iamrole, securitygroupã‚’ã‚„ã£ã¦ã„ãã€‚

# æ„Ÿæƒ³
å½“åˆæƒ³å®šã—ã¦ã„ãŸã€Œå…¨è¨­å®šã‚’1ã¤ãšã¤æ›¸ã„ã¦ã„ãã€ã‚ˆã‚Šã¯æ—©ãçµ‚ã‚ã‚Šãã†ã ãŒã€ã€importã§ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ãŸã‚Šã¨é›£æ˜“åº¦ã¯æƒ³å®šã‚ˆã‚Šä¸ŠãŒã£ã¦ã„ã‚‹ã€‚
ç·ã˜ã¦å½“åˆã®æƒ³å®šãã‚‰ã„ã®æ™‚é–“ã¯ã‹ã‹ã£ãŸã€‚

# å‚è€ƒ
Terraformã®.tfãƒ•ã‚¡ã‚¤ãƒ«ã®è¨€èªä»•æ§˜
https://developer.hashicorp.com/terraform/language

AWS ECSã®è¨­å®šä¾‹
https://qiita.com/Shoma0210/items/b998a260c5d18839fb7a

https://zenn.dev/streamwest1629/articles/terraform_import-for_beginner

https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/ecs_service

https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/ecs_task_definition#import

AWSç”¨ã®è¨­å®š
https://developer.hashicorp.com/terraform/tutorials/aws-get-started/aws-build
